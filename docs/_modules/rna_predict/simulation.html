<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>rna_predict.simulation &mdash; rna_predict 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="rna_predict 0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">rna_predict 0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for rna_predict.simulation</h1><div class="highlight"><pre>
<span class="c"># coding: utf-8</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">splitext</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">abspath</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="kn">as</span> <span class="nn">pickle</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">dcatools</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">pdbtools</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utils</span>


<div class="viewcode-block" id="check_file_existence"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.check_file_existence">[docs]</a><span class="k">def</span> <span class="nf">check_file_existence</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">alternative_error_text</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure a file exists and raise an exception otherwise.</span>

<span class="sd">    :param path: filename to check</span>
<span class="sd">    :param alternative_error_text: alternative error text passed to exception</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="n">alternative_error_text</span> <span class="k">if</span> <span class="n">alternative_error_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&quot;Cannot find file: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="check_dir_existence"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.check_dir_existence">[docs]</a><span class="k">def</span> <span class="nf">check_dir_existence</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">alternative_error_text</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure a directory exists and raise an exception otherwise.</span>

<span class="sd">    :param path: directory to check</span>
<span class="sd">    :param alternative_error_text: alternative error text passed to exception</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="n">alternative_error_text</span> <span class="k">if</span> <span class="n">alternative_error_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&quot;Cannot find directory: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="delete_glob"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.delete_glob">[docs]</a><span class="k">def</span> <span class="nf">delete_glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">print_notice</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to delete files while expanding shell globs.</span>

<span class="sd">    :param pattern: pattern to delete</span>
<span class="sd">    :param print_notice: if True print verbose notice</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">print_notice</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;deleting </span><span class="si">%s</span><span class="s">...&quot;</span> <span class="o">%</span> <span class="n">f</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">pass</span>

</div>
<div class="viewcode-block" id="get_model_count_in_silent_file"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.get_model_count_in_silent_file">[docs]</a><span class="k">def</span> <span class="nf">get_model_count_in_silent_file</span><span class="p">(</span><span class="n">silent_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the number of models present in a Rosetta silent file.</span>

<span class="sd">    :param silent_file: filename</span>
<span class="sd">    :return: model count</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">silent_file</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">pattern_model</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^SCORE:\s+[0-9.-]+.*&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pattern_model</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">n</span>

</div>
<div class="viewcode-block" id="merge_silent_files"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.merge_silent_files">[docs]</a><span class="k">def</span> <span class="nf">merge_silent_files</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">sources</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merges rosetta silent files (.out).</span>

<span class="sd">    All source files are appended to target.</span>
<span class="sd">    Model numbers are incremented uniquely.</span>
<span class="sd">    Source files are deleted after a successful merge.</span>

<span class="sd">    :param target: target filename</span>
<span class="sd">    :param sources: source filenames</span>
<span class="sd">    :return: model count</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># see how many structures we have already</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">get_model_count_in_silent_file</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c"># loop through all source files and append all new structures to target</span>
    <span class="c"># while adjusting the numbering</span>
    <span class="n">pattern_header</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^(?:SEQUENCE:|SCORE:\s+score).*&quot;</span><span class="p">)</span>
    <span class="n">pattern_normal</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^(.*)S_\d+$&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sources</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;merging </span><span class="si">%s</span><span class="s"> into </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">&quot;a+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">pattern_header</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="c"># only write header if this is he first one</span>
                        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">pattern_normal</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;SCORE:&quot;</span><span class="p">):</span>
                            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">S_</span><span class="si">%06d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="p">))</span>
                        <span class="k">continue</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c"># delete source files</span>
    <span class="n">delete_glob</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">print_notice</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># return total number of structures</span>
    <span class="k">return</span> <span class="n">n</span>

</div>
<div class="viewcode-block" id="natural_sort_key"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.natural_sort_key">[docs]</a><span class="k">def</span> <span class="nf">natural_sort_key</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">_nsre</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;([0-9]+)&#39;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Helper function to be used as sort key in sorted() to naturally sort numeric parts.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">_nsre</span><span class="p">,</span> <span class="n">s</span><span class="p">)]</span>


<span class="c"># TODO: Correcting atom names IS MOST LIKELY WRONG! It is commented out for now and can probably be removed completely.</span></div>
<div class="viewcode-block" id="fix_atom_names_in_cst"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.fix_atom_names_in_cst">[docs]</a><span class="k">def</span> <span class="nf">fix_atom_names_in_cst</span><span class="p">(</span><span class="n">cst_info</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Switches N1 and N3 atom names in a residue.</span>

<span class="sd">    :param cst_info: list of constraints</span>
<span class="sd">    :param sequence: residue sequence in lower case</span>
<span class="sd">    :return: modified list of constraints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pyrimidines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;u&#39;</span><span class="p">]</span>
    <span class="n">purines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">]</span>
    <span class="n">cst_info_new</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cst</span> <span class="ow">in</span> <span class="n">cst_info</span><span class="p">:</span>
        <span class="n">atom_name1</span><span class="p">,</span> <span class="n">res1</span><span class="p">,</span> <span class="n">atom_name2</span><span class="p">,</span> <span class="n">res2</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="n">cst</span>
        <span class="k">if</span> <span class="n">sequence</span><span class="p">[</span><span class="n">res1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">pyrimidines</span> <span class="ow">and</span> <span class="n">atom_name1</span> <span class="o">==</span> <span class="s">&#39;N1&#39;</span><span class="p">:</span>
            <span class="n">atom_name1</span> <span class="o">=</span> <span class="s">&#39;N3&#39;</span>
            <span class="k">print</span> <span class="s">&#39;correcting atom name for &#39;</span><span class="p">,</span> <span class="n">res1</span>
        <span class="k">if</span> <span class="n">sequence</span><span class="p">[</span><span class="n">res2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">pyrimidines</span> <span class="ow">and</span> <span class="n">atom_name2</span> <span class="o">==</span> <span class="s">&#39;N1&#39;</span><span class="p">:</span>
            <span class="n">atom_name2</span> <span class="o">=</span> <span class="s">&#39;N3&#39;</span>
            <span class="k">print</span> <span class="s">&#39;correcting atom name for &#39;</span><span class="p">,</span> <span class="n">res2</span>
        <span class="k">if</span> <span class="n">sequence</span><span class="p">[</span><span class="n">res1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">purines</span> <span class="ow">and</span> <span class="n">atom_name1</span> <span class="o">==</span> <span class="s">&#39;N3&#39;</span><span class="p">:</span>
            <span class="n">atom_name1</span> <span class="o">=</span> <span class="s">&#39;N1&#39;</span>
            <span class="k">print</span> <span class="s">&#39;correcting atom name for &#39;</span><span class="p">,</span> <span class="n">res1</span>
        <span class="k">if</span> <span class="n">sequence</span><span class="p">[</span><span class="n">res2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">purines</span> <span class="ow">and</span> <span class="n">atom_name2</span> <span class="o">==</span> <span class="s">&#39;N3&#39;</span><span class="p">:</span>
            <span class="n">atom_name2</span> <span class="o">=</span> <span class="s">&#39;N1&#39;</span>
            <span class="k">print</span> <span class="s">&#39;correcting atom name for &#39;</span><span class="p">,</span> <span class="n">res2</span>
        <span class="n">cst_info_new</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom_name1</span><span class="p">,</span> <span class="n">res1</span><span class="p">,</span> <span class="n">atom_name2</span><span class="p">,</span> <span class="n">res2</span><span class="p">,</span> <span class="n">function</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">cst_info_new</span>

</div>
<div class="viewcode-block" id="SimulationException"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.SimulationException">[docs]</a><span class="k">class</span> <span class="nc">SimulationException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom exception class for foreseeable prediction errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="Command"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.Command">[docs]</a><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper class to store external program calls plus additional flags.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Command.__init__"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.Command.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">add_suffix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">print_commands</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new command wrapper.</span>

<span class="sd">        :param command: list of external command and parameters</span>
<span class="sd">        :param add_suffix: type of suffix to first entry in command. currently only ``None`` or ``rosetta`` are supported</span>
<span class="sd">        :param dry_run: don&#39;t actually execute anything</span>
<span class="sd">        :param print_commands: print commandline when running</span>
<span class="sd">        :param stdin: optional text to use as standard input</span>
<span class="sd">        :param quiet: hide output of external program</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_suffix</span> <span class="o">=</span> <span class="n">add_suffix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="n">dry_run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_commands</span> <span class="o">=</span> <span class="n">print_commands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">stdin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span>
</div>
<div class="viewcode-block" id="Command.get_full_command"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.Command.get_full_command">[docs]</a>    <span class="k">def</span> <span class="nf">get_full_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sysconfig</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If necessary, add the suffix to the command. Depending on user / system configuration.</span>

<span class="sd">        :param sysconfig: instance of SysConfig</span>
<span class="sd">        :return: suffixed command as a list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">com</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_suffix</span> <span class="o">==</span> <span class="s">&quot;rosetta&quot;</span><span class="p">:</span>
            <span class="n">com</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">rosetta_exe_path</span> <span class="o">+</span> <span class="n">com</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">rosetta_exe_suffix</span>
        <span class="k">if</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">subprocess_buffsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">com</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;stdbuf&quot;</span><span class="p">,</span> <span class="s">&quot;-o&quot;</span><span class="p">,</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">subprocess_buffsize</span><span class="p">]</span> <span class="o">+</span> <span class="n">com</span>
        <span class="k">return</span> <span class="n">com</span>

</div></div>
<div class="viewcode-block" id="EvalData"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.EvalData">[docs]</a><span class="k">class</span> <span class="nc">EvalData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluation data storing model and cluster information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="EvalData.__init__"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.EvalData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create empty EvalData object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_cutoff</span> <span class="o">=</span> <span class="mf">0.0</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="EvalData.load_from_cst"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.EvalData.load_from_cst">[docs]</a>    <span class="k">def</span> <span class="nf">load_from_cst</span><span class="p">(</span><span class="n">constraints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load evaluation data from a prediction.</span>

<span class="sd">        :param constraints: constraints selection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cst_name</span><span class="p">,</span> <span class="n">cst_file</span> <span class="o">=</span> <span class="n">RNAPrediction</span><span class="o">.</span><span class="n">parse_cst_name_and_filename</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">EvalData</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/output/evaldata.dat&quot;</span> <span class="o">%</span> <span class="n">cst_name</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="EvalData.load_from_file"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.EvalData.load_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">load_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load evaluation data from a file.</span>

<span class="sd">        :param filename: path to a file containing the evaluation data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">eval_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">&quot;rmsd_cluster_1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">next</span><span class="p">(</span><span class="n">eval_data</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()):</span>
                    <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;evaluation data file &#39;</span><span class="si">%s</span><span class="s">&#39; does not contain needed information&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">eval_data</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PickleError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="c"># file broken or missing, force full evaluation</span>
            <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;evaluation data file &#39;</span><span class="si">%s</span><span class="s">&#39; missing or broken&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EvalData.save_to_file"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.EvalData.save_to_file">[docs]</a>    <span class="k">def</span> <span class="nf">save_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dump evaldata to a file.</span>

<span class="sd">        :param filename: path to a file to store the data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EvalData.get_model_count"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.EvalData.get_model_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of models in the vaulation data</span>

<span class="sd">        :return: number of models</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EvalData.get_models"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.EvalData.get_models">[docs]</a>    <span class="k">def</span> <span class="nf">get_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&quot;tag&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a selection of models with specific properties</span>

<span class="sd">        :param model_list: list of models to get, might be a list of numbers, or a list of model names</span>
<span class="sd">        :param kind: model selection mode:</span>

<span class="sd">            - ``tag``: str: internal name such as S_000123_5</span>
<span class="sd">            - ``top``: int: models ordered by score</span>
<span class="sd">            - ``ntop``: int: models ordered by rmsd_native</span>
<span class="sd">            - ``cluster``: int: nth cluster decoy</span>
<span class="sd">            - ``cluster_ntop``: n[/m]: nth cluster ordered by native rmsd [of first m]</span>

<span class="sd">        :return: list of selected models</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># initialize list</span>
        <span class="n">models_sorted</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">model_i</span> <span class="ow">in</span> <span class="n">model_list</span><span class="p">:</span>
            <span class="c"># decide which model we want</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&quot;cluster&quot;</span><span class="p">:</span>
                <span class="n">model_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">model_i</span><span class="p">)</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">model_i</span><span class="p">][</span><span class="s">&quot;primary_model&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&quot;cluster_ntop&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">model_i</span><span class="p">:</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">model_i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;get_models: Cluster number (</span><span class="si">%d</span><span class="s">) can&#39;t be larger than the limit (</span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">limit</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">model_i</span><span class="p">)</span>
                    <span class="n">limit</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">model_selection</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="s">&quot;primary_model&quot;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">values</span><span class="p">()[:</span><span class="n">limit</span><span class="p">]]</span>
                <span class="n">models_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model_selection</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="s">&quot;rmsd_native&quot;</span><span class="p">])</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">models_sorted</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s">&quot;tag&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&quot;tag&quot;</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">model_i</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&quot;top&quot;</span><span class="p">:</span>
                <span class="n">model_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">model_i</span><span class="p">)</span>
                <span class="c"># do we need to create a sorted list?</span>
                <span class="k">if</span> <span class="n">models_sorted</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">models_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&quot;score&quot;</span><span class="p">])</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">models_sorted</span><span class="p">[</span><span class="n">model_i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&quot;ntop&quot;</span><span class="p">:</span>
                <span class="n">model_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">model_i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">models_sorted</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">models_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&quot;rmsd_native&quot;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;get_models: No native rmsd information stored&quot;</span><span class="p">)</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">models_sorted</span><span class="p">[</span><span class="n">model_i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;get_models: Invalid &#39;kind&#39; parameter: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">kind</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;get_models: Invalid tag: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">results</span>
</div>
<div class="viewcode-block" id="EvalData.print_models"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.EvalData.print_models">[docs]</a>    <span class="k">def</span> <span class="nf">print_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&quot;tag&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print a list of models</span>

<span class="sd">        :param model_list: see get_models</span>
<span class="sd">        :param kind: see get_models</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_models</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="n">kind</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Model: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">model</span><span class="p">[</span><span class="s">&quot;tag&quot;</span><span class="p">]</span>
            <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="EvalData.get_weighted_model_score"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.EvalData.get_weighted_model_score">[docs]</a>    <span class="k">def</span> <span class="nf">get_weighted_model_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">score_weights</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate a model score based on different weights for the invidiual Rosetta scores</span>

<span class="sd">        :param model: model to reweight</span>
<span class="sd">        :param score_weights: dict of rosetta score names and their weights. ``default`` to set the default weight for all scores. Example: ``{&#39;default&#39;:0, &#39;atom_pair_constraint&#39;: 1}`` to only use atom pair constraints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="p">[</span><span class="s">&quot;rosetta_scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s">&quot;description&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="p">(</span><span class="n">score_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">score_weights</span> <span class="k">else</span> <span class="p">(</span><span class="n">score_weights</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s">&quot;default&quot;</span> <span class="ow">in</span> <span class="n">score_weights</span> <span class="k">else</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">model</span><span class="p">[</span><span class="s">&quot;rosetta_scores&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">score</span>

</div></div>
<div class="viewcode-block" id="RNAPrediction"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction">[docs]</a><span class="k">class</span> <span class="nc">RNAPrediction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class used for prediction simulation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONFIG_FILE</span> <span class="o">=</span> <span class="s">&quot;.config&quot;</span>

<div class="viewcode-block" id="RNAPrediction.load_config"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.load_config">[docs]</a>    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load simulation configuration of current directory&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">RNAPrediction</span><span class="o">.</span><span class="n">CONFIG_FILE</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">RNAPrediction</span><span class="o">.</span><span class="n">CONFIG_FILE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="RNAPrediction.save_config"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.save_config">[docs]</a>    <span class="k">def</span> <span class="nf">save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save simulation configuration of current directorx&quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">RNAPrediction</span><span class="o">.</span><span class="n">CONFIG_FILE</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="RNAPrediction.print_config"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.print_config">[docs]</a>    <span class="k">def</span> <span class="nf">print_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print simulation configuration.&quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="s">&quot;Simulation configuration:&quot;</span>
        <span class="k">print</span> <span class="s">&quot;    path: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&quot;motif_res_maps&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&quot;motif_stem_sets&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&quot;motifs&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&quot;stems&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&quot;evaluate&quot;</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;    </span><span class="si">%s</span><span class="s">: ...&quot;</span> <span class="o">%</span> <span class="n">key</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;    </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;    No configuration found.&quot;</span>

    <span class="c"># TODO: support different data types?</span></div>
<div class="viewcode-block" id="RNAPrediction.modify_config"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.modify_config">[docs]</a>    <span class="k">def</span> <span class="nf">modify_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modify configuration entry.</span>

<span class="sd">        :param key: setting to modify</span>
<span class="sd">        :param value: new value (&quot;-&quot; to store None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s">&quot;-&quot;</span> <span class="k">else</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;No such config entry: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RNAPrediction.check_config"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.check_config">[docs]</a>    <span class="k">def</span> <span class="nf">check_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if current directory contains a valid configuraion.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;No config file found. Please run &#39;prepare&#39; first!&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RNAPrediction.__init__"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sysconfig</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a prediction simulation for the current directory and try to load an existing configuration.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sysconfig</span> <span class="o">=</span> <span class="n">sysconfig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="RNAPrediction.execute_command"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.execute_command">[docs]</a>    <span class="k">def</span> <span class="nf">execute_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">add_suffix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">print_commands</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute an external command.</span>

<span class="sd">        :param command: list of external command and parameters</span>
<span class="sd">        :param add_suffix: type of suffix to first entry in command. currently only ``None`` or ``rosetta`` are supported</span>
<span class="sd">        :param dry_run: don&#39;t actually execute anything</span>
<span class="sd">        :param print_commands: print commandline when running</span>
<span class="sd">        :param stdin: optional text to use as standard input</span>
<span class="sd">        :param quiet: hide output of external program</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_commands</span><span class="p">([</span><span class="n">Command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">add_suffix</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">print_commands</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">quiet</span><span class="p">)])</span>
</div>
<div class="viewcode-block" id="RNAPrediction.execute_command_and_capture"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.execute_command_and_capture">[docs]</a>    <span class="k">def</span> <span class="nf">execute_command_and_capture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">add_suffix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">print_commands</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute an external command while capturing output.</span>

<span class="sd">        :param command: list of external command and parameters</span>
<span class="sd">        :param add_suffix: type of suffix to first entry in command. currently only ``None`` or ``rosetta`` are supported</span>
<span class="sd">        :param dry_run: don&#39;t actually execute anything</span>
<span class="sd">        :param print_commands: print commandline when running</span>
<span class="sd">        :param stdin: optional text to use as standard input</span>
<span class="sd">        :param quiet: hide output of external program</span>
<span class="sd">        :return: generator over lines of standard output</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">add_suffix</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">print_commands</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">quiet</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get_full_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sysconfig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">print_commands</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;Failed to execute command: </span><span class="si">%s</span><span class="s">, Reason: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">command</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">line</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;Non-zero return code from executed command: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">command</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="RNAPrediction.execute_commands"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.execute_commands">[docs]</a>    <span class="k">def</span> <span class="nf">execute_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commands</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a list of commands parallelly.</span>

<span class="sd">        :param commands: list of Commands</span>
<span class="sd">        :param threads: number of parallel invocations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">commands</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threads</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get_full_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sysconfig</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">print_commands</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                        <span class="n">stdout</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">quiet</span> <span class="ow">and</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
                        <span class="n">stderr</span> <span class="o">=</span> <span class="n">stdout</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>
                            <span class="c"># store original command in process</span>
                            <span class="n">p</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
                            <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;Failed to execute command: </span><span class="si">%s</span><span class="s">, Reason: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">command</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">processes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;Non-zero return code from executed command: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">command</span><span class="p">))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">processes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">commands</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="c"># kill all other processes</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_tag_with_dashes</span><span class="p">(</span><span class="n">int_vector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a list of values into a list of strings while using &quot;n-m&quot; for adjacent values.</span>

<span class="sd">        Example: Turns ``[1, 2, 3, 5, 7, 8]`` into ``[&#39;1-3&#39;, &#39;5&#39;, &#39;7-8&#39;]``.</span>

<span class="sd">        :param int_vector: list of values</span>
<span class="sd">        :return: list of strings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">start_res</span> <span class="o">=</span> <span class="n">int_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_vector</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_vector</span><span class="p">)</span> <span class="ow">or</span> <span class="n">int_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">int_vector</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>

                <span class="n">stop_res</span> <span class="o">=</span> <span class="n">int_vector</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">stop_res</span> <span class="o">&gt;</span> <span class="n">start_res</span><span class="p">:</span>
                    <span class="n">tag</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">-</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">start_res</span><span class="p">,</span> <span class="n">stop_res</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tag</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">stop_res</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_vector</span><span class="p">):</span>
                    <span class="n">start_res</span> <span class="o">=</span> <span class="n">int_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">tag</span>

    <span class="c"># noinspection PyMethodMayBeStatic</span>
<div class="viewcode-block" id="RNAPrediction.get_csts"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.get_csts">[docs]</a>    <span class="k">def</span> <span class="nf">get_csts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of all constraints.</span>

<span class="sd">        :return: list of all constraints names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># loop over all constraint sets</span>
        <span class="c"># that is either files in the &quot;constraints&quot; directory, or directories under &quot;predictions&quot;, and always &quot;none&quot;</span>
        <span class="n">cst_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;none&quot;</span><span class="p">]</span>
        <span class="n">cst_names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">cst_file</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">cst_file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">&quot;constraints/*.cst&quot;</span><span class="p">)]</span>
        <span class="n">cst_names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">basename</span><span class="p">(</span><span class="n">cst_dir</span><span class="p">)</span> <span class="k">for</span> <span class="n">cst_dir</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">&quot;predictions/*&quot;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cst_names</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">natural_sort_key</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RNAPrediction.prepare"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fasta_file</span><span class="o">=</span><span class="s">&quot;sequence.fasta&quot;</span><span class="p">,</span> <span class="n">params_file</span><span class="o">=</span><span class="s">&quot;secstruct.txt&quot;</span><span class="p">,</span> <span class="n">native_pdb_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">torsions_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preparation step. Parse out stems and motifs from sequence and secondary structure information and create necessary base files.</span>

<span class="sd">        :param fasta_file: fasta file containing the sequence</span>
<span class="sd">        :param params_file: text file containing the secondary structure</span>
<span class="sd">        :param native_pdb_file: native pdb file if available</span>
<span class="sd">        :param data_file: additional data file if available</span>
<span class="sd">        :param torsions_file: additional torsions file if available</span>
<span class="sd">        :param name: optional name for this set of predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fasta_file</span><span class="p">,</span> <span class="n">params_file</span><span class="p">,</span> <span class="n">native_pdb_file</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">torsions_file</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">check_file_existence</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s">&quot;constraints&quot;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s">&quot;preparation&quot;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s">&quot;dca&quot;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s">&quot;predictions&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;fasta_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fasta_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;params_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;native_pdb_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">native_pdb_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;data_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;torsions_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torsions_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">print</span>
        <span class="k">print</span> <span class="s">&quot;Preparation:&quot;</span>

        <span class="c"># Read in files</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_file_line_by_line</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&gt;&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">]</span>
        <span class="n">numres</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">])</span>

        <span class="c"># Read in data information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;data_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">data_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;backbone_burial_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_file_line_by_line</span><span class="p">(</span><span class="n">data_file</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;EXPOSE&#39;</span><span class="p">:</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;data_info&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">cols</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="n">cols</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[:</span><span class="mi">15</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;BACKBONE_BURIAL&#39;</span><span class="p">:</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;backbone_burial_info&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="n">pair_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">all_pairs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">complement</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;u&#39;</span><span class="p">],</span> <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">],</span> <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">],</span> <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;u&#39;</span><span class="p">]}</span>

        <span class="c"># Parse out stems</span>
        <span class="n">basepair_mismatch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cutpoints_original</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_file_line_by_line</span><span class="p">(</span><span class="n">params_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;STEM&#39;</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;PAIR&#39;</span><span class="p">:</span>
                        <span class="c"># Offset to get to python numbering (starts with zero)</span>
                        <span class="n">res1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">res2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">pair_map</span><span class="p">[</span><span class="n">res1</span><span class="p">]</span> <span class="o">=</span> <span class="n">res2</span>
                        <span class="n">pair_map</span><span class="p">[</span><span class="n">res2</span><span class="p">]</span> <span class="o">=</span> <span class="n">res1</span>
                        <span class="n">all_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">])</span>
                        <span class="c"># check if the secondary structure watson-crick pair is allowed</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">][</span><span class="n">res1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">complement</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">][</span><span class="n">res2</span><span class="p">]]:</span>
                            <span class="n">basepair_mismatch</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c"># maybe dot/bracket notation (((...)))</span>
                <span class="k">print</span> <span class="n">line</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;secstruc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
                <span class="n">left_brackets</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
                        <span class="n">left_brackets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">:</span>
                        <span class="n">res1</span> <span class="o">=</span> <span class="n">left_brackets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">res2</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">del</span> <span class="p">(</span><span class="n">left_brackets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">pair_map</span><span class="p">[</span><span class="n">res1</span><span class="p">]</span> <span class="o">=</span> <span class="n">res2</span>
                        <span class="n">pair_map</span><span class="p">[</span><span class="n">res2</span><span class="p">]</span> <span class="o">=</span> <span class="n">res1</span>
                        <span class="n">all_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">])</span>
                        <span class="c"># check if the secondary structure watson-crick pair is allowed</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">][</span><span class="n">res1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">complement</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">][</span><span class="n">res2</span><span class="p">]]:</span>
                            <span class="n">basepair_mismatch</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">left_brackets</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;unbalanced paranthesis in secondary structure&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">res1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">res2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">pair_map</span><span class="p">[</span><span class="n">res1</span><span class="p">]</span> <span class="o">=</span> <span class="n">res2</span>
                <span class="n">pair_map</span><span class="p">[</span><span class="n">res2</span><span class="p">]</span> <span class="o">=</span> <span class="n">res1</span>
                <span class="n">all_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">])</span>
                <span class="c"># check if the secondary structure watson-crick pair is allowed</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">][</span><span class="n">res1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">complement</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">][</span><span class="n">res2</span><span class="p">]]:</span>
                    <span class="n">basepair_mismatch</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">]]</span>

            <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">13</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CUTPOINT_OPEN&#39;</span><span class="p">:</span>
                <span class="n">cutpoints_original</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">14</span><span class="p">:]))</span>

        <span class="c"># print all helix pairs that don&#39;t fit the allowed complements</span>
        <span class="k">if</span> <span class="n">basepair_mismatch</span><span class="p">:</span>
            <span class="n">basepair_mismatch_str</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot; &quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">basepair_mismatch</span><span class="p">:</span>
                <span class="n">basepair_mismatch_str</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="s">&quot;^&quot;</span>
                <span class="n">basepair_mismatch_str</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="s">&quot;^&quot;</span>
            <span class="k">print</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basepair_mismatch_str</span><span class="p">)</span>

            <span class="c"># more verbose:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">basepair_mismatch</span><span class="p">:</span>
                <span class="n">res1</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">res2</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">resstr1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">res1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">][</span><span class="n">res1</span><span class="p">]</span>
                <span class="n">resstr2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">res2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">][</span><span class="n">res2</span><span class="p">]</span>
                <span class="k">print</span> <span class="s">&quot; &quot;</span> <span class="o">*</span> <span class="n">res1</span> <span class="o">+</span> <span class="s">&quot;^&quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">res2</span> <span class="o">-</span> <span class="n">res1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;^&quot;</span>
                <span class="k">print</span> <span class="s">&quot; &quot;</span> <span class="o">*</span> <span class="n">res1</span> <span class="o">+</span> <span class="n">resstr1</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">res2</span> <span class="o">-</span> <span class="n">res1</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">resstr1</span><span class="p">))</span> <span class="o">+</span> <span class="n">resstr2</span>

            <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;some helix pairs in secondary structure cannot be realized (see above)&quot;</span><span class="p">)</span>

        <span class="c"># print pair_map</span>

        <span class="c"># Parse out stems</span>
        <span class="n">already_in_stem</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numres</span><span class="p">):</span>
            <span class="n">already_in_stem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numres</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pair_map</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">already_in_stem</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>  <span class="c"># In a base pair</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">stem_res</span> <span class="o">=</span> <span class="p">[[</span><span class="n">k</span><span class="p">,</span> <span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">]]]</span>

                <span class="n">already_in_stem</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">already_in_stem</span><span class="p">[</span><span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c"># Can we extend in one direction?</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pair_map</span> <span class="ow">and</span> <span class="n">pair_map</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">already_in_stem</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">stem_res</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                    <span class="n">already_in_stem</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">already_in_stem</span><span class="p">[</span><span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c"># Do not allow single WC base pairs.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stem_res</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;All stems must have length &gt; 1 bp &#39;</span>
                    <span class="k">print</span> <span class="n">stem_res</span>
                    <span class="nb">exit</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stem_res</span><span class="p">)</span>

        <span class="c"># Parse out motifs</span>
        <span class="n">already_in_motif</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numres</span><span class="p">):</span>
            <span class="n">already_in_motif</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">motif_cutpoints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motif_res_maps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motif_stem_sets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motifs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numres</span><span class="p">):</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">already_in_motif</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">already_in_stem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span>
                                                                       <span class="ow">and</span> <span class="n">already_in_stem</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                                                                       <span class="ow">and</span> <span class="n">pair_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">pair_map</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])):</span>

                <span class="n">motif_res</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">motif_stem_set</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">cutpoints</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

                    <span class="c"># back up to beginning of stem.</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>

                    <span class="c"># first base pair.</span>
                    <span class="n">motif_stem</span> <span class="o">=</span> <span class="p">[[</span><span class="n">k</span><span class="p">,</span> <span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">]]]</span>
                    <span class="n">motif_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">motif_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

                    <span class="n">k</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">while</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">already_in_stem</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> \
                            <span class="p">(</span><span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">pair_map</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>
                        <span class="n">motif_stem</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                        <span class="n">motif_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="n">motif_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">k</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">motif_stem_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">motif_stem</span><span class="p">)</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">cutpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

                <span class="c"># print &#39;AFTER FIRST HELIX: &#39;, motif_res</span>

                <span class="n">k</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">while</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">motif_res</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">numres</span><span class="p">:</span>
                    <span class="c"># Move forward to next stem:</span>
                    <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">numres</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">already_in_stem</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">already_in_motif</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                            <span class="k">print</span> <span class="s">&#39;Hey cant deal with pseudoknots!&#39;</span>
                            <span class="nb">exit</span><span class="p">()</span>
                        <span class="n">motif_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">stem_start</span> <span class="o">=</span> <span class="n">k</span>

                    <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="n">numres</span><span class="p">:</span>
                        <span class="n">cutpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">break</span>

                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">motif_res</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="n">motif_stem</span> <span class="o">=</span> <span class="p">[[</span><span class="n">k</span><span class="p">,</span> <span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">]]]</span>
                    <span class="n">motif_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">motif_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">numres</span> <span class="ow">and</span> <span class="n">already_in_stem</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="n">pair_map</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">motif_res</span><span class="p">:</span>
                        <span class="n">motif_stem</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                        <span class="n">motif_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="n">motif_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair_map</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">motif_stem_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">motif_stem</span><span class="p">)</span>
                    <span class="n">cutpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="c"># Next non-helical part..</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">pair_map</span><span class="p">[</span><span class="n">stem_start</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c"># print &#39;AFTER NEXT HELIX: &#39;, motif_res</span>

                <span class="n">motif_res</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

                <span class="n">motif_res_map</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">motif_res</span><span class="p">)):</span>
                    <span class="n">motif_res_map</span><span class="p">[</span><span class="n">motif_res</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="n">already_in_motif</span><span class="p">[</span><span class="n">motif_res</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motifs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">motif_res</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motif_stem_sets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">motif_stem_set</span><span class="p">)</span>
                <span class="n">motif_cutpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cutpoints</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motif_res_maps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">motif_res_map</span><span class="p">)</span>
                <span class="c"># print &#39;CUTPOINTS &#39;, cutpoints</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">])):</span>

            <span class="c"># Fasta</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;preparation/stem</span><span class="si">%d</span><span class="s">.fasta&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

            <span class="n">stem_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">stem_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stem_res</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stem_length</span><span class="p">):</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">][</span><span class="n">stem_res</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
                <span class="c"># print stem_res[k][0]+1,</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stem_length</span><span class="p">):</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">][</span><span class="n">stem_res</span><span class="p">[</span><span class="n">stem_length</span> <span class="o">-</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                <span class="c"># print stem_res[stem_length-k-1][1]+1,</span>

            <span class="c"># print</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&#39;Created: &#39;</span><span class="p">,</span> <span class="n">tag</span>

            <span class="c"># pdb_file</span>
            <span class="k">if</span> <span class="n">native_pdb_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;pdbslice.py&quot;</span><span class="p">,</span>
                           <span class="n">native_pdb_file</span><span class="p">,</span>
                           <span class="s">&quot;-segment&quot;</span><span class="p">,</span>
                           <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stem_res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                           <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stem_res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                           <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stem_res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                           <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stem_res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                           <span class="s">&quot;preparation/stem</span><span class="si">%d</span><span class="s">_&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="n">native_pdb_file_subset</span> <span class="o">=</span> <span class="s">&#39;preparation/stem</span><span class="si">%d</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">native_pdb_file</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&#39;Created: &#39;</span><span class="p">,</span> <span class="n">native_pdb_file_subset</span>

        <span class="c"># Output motif jobs</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motifs&quot;</span><span class="p">])):</span>

            <span class="c"># Fasta</span>
            <span class="n">motif_fasta_file</span> <span class="o">=</span> <span class="s">&#39;preparation/motif</span><span class="si">%d</span><span class="s">.fasta&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">motif_fasta_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span> <span class="o">+</span> <span class="n">motif_fasta_file</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

            <span class="n">motif_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motifs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">motif_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">motif_res</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">motif_length</span><span class="p">):</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">][</span><span class="n">motif_res</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&#39;Created: &#39;</span><span class="p">,</span> <span class="n">motif_fasta_file</span>

            <span class="c"># params file</span>
            <span class="n">motif_stem_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motif_stem_sets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">motif_res_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motif_res_maps&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">motif_cutpoint</span> <span class="o">=</span> <span class="n">motif_cutpoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">motif_params_file</span> <span class="o">=</span> <span class="s">&#39;preparation/motif</span><span class="si">%d</span><span class="s">.params&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">motif_params_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">motif_stem_set</span><span class="p">)):</span>
                <span class="n">motif_stem</span> <span class="o">=</span> <span class="n">motif_stem_set</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;STEM   &#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">motif_stem</span><span class="p">)):</span>
                    <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;  PAIR </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> W W A&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">motif_res_map</span><span class="p">[</span><span class="n">motif_stem</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                               <span class="n">motif_res_map</span><span class="p">[</span><span class="n">motif_stem</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;OBLIGATE PAIR </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> W W A </span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">motif_res_map</span><span class="p">[</span><span class="n">motif_stem</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">motif_res_map</span><span class="p">[</span><span class="n">motif_stem</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

            <span class="n">motif_cutpoint</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="c"># print motif_res</span>
            <span class="c"># print motif_cutpoint</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">motif_cutpoint</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;CUTPOINT_OPEN &#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">motif_cutpoint</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">motif_res_map</span><span class="p">[</span><span class="n">motif_cutpoint</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">motif_res</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">motif_res_map</span><span class="p">[</span><span class="n">motif_cutpoint</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&#39;Created: &#39;</span><span class="p">,</span> <span class="n">motif_params_file</span>

            <span class="c"># pdb_file</span>
            <span class="k">if</span> <span class="n">native_pdb_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;pdbslice.py&quot;</span><span class="p">,</span>
                           <span class="n">native_pdb_file</span><span class="p">,</span>
                           <span class="s">&quot;-subset&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">motif_length</span><span class="p">):</span>
                    <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">motif_res</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;preparation/motif</span><span class="si">%d</span><span class="s">_&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="n">native_pdb_file_subset</span> <span class="o">=</span> <span class="s">&#39;preparation/motif</span><span class="si">%d</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">native_pdb_file</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&#39;Created: &#39;</span><span class="p">,</span> <span class="n">native_pdb_file_subset</span>

            <span class="k">if</span> <span class="n">data_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">motif_data_file</span> <span class="o">=</span> <span class="s">&#39;preparation/motif</span><span class="si">%d</span><span class="s">.data&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">fid_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">motif_data_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">fid_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;EXPOSE&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;data_info&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">motif_res_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">fid_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;   </span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">motif_res_map</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">fid_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;backbone_burial_info&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fid_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;BACKBONE_BURIAL &#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;backbone_burial_info&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">motif_res_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">fid_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">motif_res_map</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">fid_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">fid_data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">print</span> <span class="s">&#39;Created: &#39;</span><span class="p">,</span> <span class="n">motif_data_file</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cutpoints_original</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># noinspection PyUnboundLocalVariable</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;CUTPOINT_OPEN &#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cutpoint</span> <span class="ow">in</span> <span class="n">cutpoints_original</span><span class="p">:</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cutpoint</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="n">cutpoints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motifs&quot;</span><span class="p">])):</span>

            <span class="n">motif_stem_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motif_stem_sets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

            <span class="n">motif_stem</span> <span class="o">=</span> <span class="n">motif_stem_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">possible_cutpoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">motif_stem</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">motif_stem</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">possible_cutpoints</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="c"># print possible_cutpoints</span>
            <span class="k">if</span> <span class="n">possible_cutpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cutpoints</span><span class="p">:</span>
                <span class="n">cutpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">possible_cutpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">params_file</span> <span class="o">=</span> <span class="s">&quot;preparation/sequence.params&quot;</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cutpoints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;CUTPOINT_CLOSED &#39;</span><span class="p">)</span>
            <span class="c"># cutpoints.sort()</span>
            <span class="k">for</span> <span class="n">cutpoint</span> <span class="ow">in</span> <span class="n">cutpoints</span><span class="p">:</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cutpoint</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="c"># for cutpoint in cutpoints:</span>
        <span class="c"># fid.write( &#39;OBLIGATE   PAIR %d %d W W A\n&#39; % (cutpoint+1, pair_map[cutpoint]+1) )</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">])):</span>
            <span class="n">stem_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;STEM &#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stem_res</span><span class="p">)):</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; PAIR </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> W W A &#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">stem_res</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stem_res</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;OBLIGATE PAIR </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> W W A </span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">stem_res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">stem_res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">fid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;Created: &#39;</span><span class="p">,</span> <span class="n">params_file</span>

        <span class="c"># default cutpoint constraints</span>
        <span class="n">assemble_cst_file</span> <span class="o">=</span> <span class="s">&quot;preparation/cutpoints.cst&quot;</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">assemble_cst_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;[ atompairs ]</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cutpoint</span> <span class="ow">in</span> <span class="n">cutpoints</span><span class="p">:</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;O3&#39;  </span><span class="si">%d</span><span class="s">  P     </span><span class="si">%d</span><span class="s">  HARMONIC  1.619  2.0</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cutpoint</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cutpoint</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;Created: &#39;</span><span class="p">,</span> <span class="n">assemble_cst_file</span>
</div>
<div class="viewcode-block" id="RNAPrediction.create_helices"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.create_helices">[docs]</a>    <span class="k">def</span> <span class="nf">create_helices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helix creation step. Create one ideal helix model for each helix.</span>

<span class="sd">        :param dry_run: don&#39;t actually run any external command</span>
<span class="sd">        :param threads: number of threads to use</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_config</span><span class="p">()</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">delete_glob</span><span class="p">(</span><span class="s">&quot;preparation/stem*.out&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">])):</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;rna_helix&quot;</span><span class="p">,</span>
                       <span class="s">&quot;-fasta&quot;</span><span class="p">,</span> <span class="s">&quot;preparation/stem</span><span class="si">%d</span><span class="s">.fasta&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                       <span class="s">&quot;-out:file:silent&quot;</span><span class="p">,</span> <span class="s">&quot;preparation/stem</span><span class="si">%d</span><span class="s">.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">add_suffix</span><span class="o">=</span><span class="s">&quot;rosetta&quot;</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span>

        <span class="c"># rna_helix dumps &lt;sequence&gt;.pdb files in the working directory.</span>
        <span class="c"># These can be useful for us, so move them to the preparation directory with a proper stemX.pdb filename.</span>
        <span class="c"># TODO: What happens if there are multiple helices with the same sequence? In that case we need to move them</span>
        <span class="c"># out of the way before running the next command.</span>
        <span class="c"># Just disable multithreading here (not really needed with stem generation anyways)?</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">])):</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">sequence</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])]</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">.pdb&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sequence</span><span class="p">)),</span> <span class="s">&quot;preparation/stem</span><span class="si">%d</span><span class="s">.pdb&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="RNAPrediction.parse_cst_name_and_filename"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.parse_cst_name_and_filename">[docs]</a>    <span class="k">def</span> <span class="nf">parse_cst_name_and_filename</span><span class="p">(</span><span class="n">constraints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find and clean up constraints by name or filename</span>

<span class="sd">        :param constraints: constraints name or filename</span>
<span class="sd">        :return: tuple of constraints name and filename</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">constraints</span> <span class="o">==</span> <span class="s">&quot;none&quot;</span><span class="p">:</span>
            <span class="n">cst_name</span> <span class="o">=</span> <span class="s">&quot;none&quot;</span>
            <span class="n">cst_file</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">constraints</span><span class="p">):</span>
            <span class="n">cst_file</span> <span class="o">=</span> <span class="n">constraints</span>
            <span class="n">cst_name</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">cst_file</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
            <span class="n">cst_name</span><span class="p">,</span> <span class="n">cst_ext</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cst_ext</span> <span class="o">!=</span> <span class="s">&quot;.cst&quot;</span><span class="p">:</span>
                <span class="n">cst_name</span> <span class="o">=</span> <span class="n">constraints</span>
            <span class="n">cst_file</span> <span class="o">=</span> <span class="s">&quot;constraints/</span><span class="si">%s</span><span class="s">.cst&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
            <span class="n">check_file_existence</span><span class="p">(</span><span class="n">cst_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cst_name</span><span class="p">,</span> <span class="n">cst_file</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="RNAPrediction.parse_cst_file"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.parse_cst_file">[docs]</a>    <span class="k">def</span> <span class="nf">parse_cst_file</span><span class="p">(</span><span class="n">constraints_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse .cst file as a list of constraints</span>

<span class="sd">        :param constraints_file: path to a .cst file</span>
<span class="sd">        :return: list of constraints</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cst_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_file_line_by_line</span><span class="p">(</span><span class="n">constraints_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;[&#39;</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">atom_name1</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">res1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">atom_name2</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">res2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">cst_info</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom_name1</span><span class="p">,</span> <span class="n">res1</span><span class="p">,</span> <span class="n">atom_name2</span><span class="p">,</span> <span class="n">res2</span><span class="p">,</span> <span class="n">cols</span><span class="p">[</span><span class="mi">4</span><span class="p">:]])</span>
        <span class="k">return</span> <span class="n">cst_info</span>
</div>
<div class="viewcode-block" id="RNAPrediction.prepare_cst"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.prepare_cst">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_cst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">motifs_override</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constraints preparation step. Prepare constraints files for motif generation and assembly.</span>

<span class="sd">        :param constraints: constraints selection</span>
<span class="sd">        :param motifs_override: optional name of a different set of constraints to use as motifs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_config</span><span class="p">()</span>
        <span class="n">cst_name</span><span class="p">,</span> <span class="n">cst_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cst_name_and_filename</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;Constraints preparation:&quot;</span>
        <span class="k">print</span> <span class="s">&quot;    constraints: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>

        <span class="n">dir_prediction</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">dir_assembly</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/assembly&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">dir_motifs</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/motifs&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>

        <span class="k">if</span> <span class="n">motifs_override</span><span class="p">:</span>
            <span class="n">motifcst_name</span><span class="p">,</span> <span class="n">motifcst_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cst_name_and_filename</span><span class="p">(</span><span class="n">motifs_override</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;    motif constraints: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">motifcst_name</span>
            <span class="k">if</span> <span class="n">motifcst_name</span> <span class="o">==</span> <span class="n">cst_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;Motif override cst name can&#39;t be the same as the cst name!&quot;</span><span class="p">)</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cst_name</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">dir_assembly</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">motifs_override</span><span class="p">:</span>
            <span class="c"># TODO: just make all that stuff a cst config file</span>
            <span class="c"># create MOTIF_OVERRIDE file and store the cst name of the motifs</span>
            <span class="n">file_motif_override</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/MOTIF_OVERRIDE&quot;</span> <span class="o">%</span> <span class="n">dir_prediction</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_motif_override</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">motifcst_name</span><span class="p">)</span>

        <span class="c"># assembly constraints: start with default harmonic cutpoints</span>
        <span class="n">assembly_cst</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/assembly.cst&quot;</span> <span class="o">%</span> <span class="n">dir_assembly</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s">&quot;preparation/cutpoints.cst&quot;</span><span class="p">,</span> <span class="n">assembly_cst</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;Created: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">assembly_cst</span>

        <span class="c"># if cst is &quot;none&quot; we are done now</span>
        <span class="k">if</span> <span class="n">cst_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c"># load constraints information</span>
        <span class="n">cst_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cst_file</span><span class="p">(</span><span class="n">cst_file</span><span class="p">)</span>

        <span class="c"># probably wrong, commented out for now!</span>
        <span class="c"># cst_info = fix_atom_names_in_cst(cst_info, self.config[&quot;sequence&quot;])</span>

        <span class="c"># add tertiary constraints</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">assembly_cst</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ft</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cst</span> <span class="ow">in</span> <span class="n">cst_info</span><span class="p">:</span>
                <span class="n">ft</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cst</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cst</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cst</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cst</span><span class="p">[</span><span class="mi">4</span><span class="p">]))))</span>
        <span class="k">print</span> <span class="s">&quot;Added tertiary constraints: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">assembly_cst</span>

        <span class="c"># extract relevant constraints for motif generation from global cst file if necessary</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">motifs_override</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">dir_motifs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motifs&quot;</span><span class="p">])):</span>
                <span class="n">motif_res_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motif_res_maps&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">motif_cst_file</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/motif</span><span class="si">%d</span><span class="s">.cst&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_motifs</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">fid_cst</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">motif_cst_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">fid_cst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;[ atompairs ]</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cst</span> <span class="ow">in</span> <span class="n">cst_info</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">motif_res_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">cst</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">motif_res_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">fid_cst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">motif_res_map</span><span class="p">[</span><span class="n">cst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cst</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">motif_res_map</span><span class="p">[</span><span class="n">cst</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cst</span><span class="p">[</span><span class="mi">4</span><span class="p">]))))</span>
                <span class="n">fid_cst</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">print</span> <span class="s">&#39;Created: &#39;</span><span class="p">,</span> <span class="n">motif_cst_file</span>
</div>
<div class="viewcode-block" id="RNAPrediction.get_status"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.get_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">include_evaluation_data</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_motif_model_count</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_assembly_model_count</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dict containing status information for a cst.</span>

<span class="sd">        :param constraints: constraints selection</span>
<span class="sd">        :param include_motif_model_count: set to True to include model count (longer processing time)</span>
<span class="sd">        :param include_assembly_model_count: set to True to include model count (longer processing time)</span>
<span class="sd">        :param include_evaluation_data: set to True to include evaluation model count and native RMSD values (best of first 1,5,10 clusters) if available (longer processing time)</span>
<span class="sd">        :return: status dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_config</span><span class="p">()</span>
        <span class="n">cst_name</span><span class="p">,</span> <span class="n">cst_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cst_name_and_filename</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">dir_prediction</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">dir_assembly</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/assembly&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">dir_motifs</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/motifs&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">dir_output</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/output&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">file_motifoverride</span> <span class="o">=</span> <span class="n">dir_prediction</span> <span class="o">+</span> <span class="s">&quot;/MOTIF_OVERRIDE&quot;</span>
        <span class="n">file_evaldata</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/evaldata.dat&quot;</span> <span class="o">%</span> <span class="n">dir_output</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;step_preparation_done&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dir_assembly</span> <span class="o">+</span> <span class="s">&quot;/assembly.cst&quot;</span><span class="p">),</span>
               <span class="s">&quot;step_motifs_done&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">dir_motifs</span> <span class="o">+</span> <span class="s">&quot;/*.out&quot;</span><span class="p">)),</span>
               <span class="s">&quot;step_motifs_overridden&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
               <span class="s">&quot;step_assembly_done&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">dir_assembly</span> <span class="o">+</span> <span class="s">&quot;/*.out&quot;</span><span class="p">)),</span>
               <span class="s">&quot;step_evaluation_done&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_evaldata</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_motifoverride</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_motifoverride</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s">&quot;step_motifs_overridden&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c"># evaluation data</span>
        <span class="k">if</span> <span class="n">include_evaluation_data</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s">&quot;evaluation_rmsd_native&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">res</span><span class="p">[</span><span class="s">&quot;evaluation_model_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">eval_data</span> <span class="o">=</span> <span class="n">EvalData</span><span class="o">.</span><span class="n">load_from_cst</span><span class="p">(</span><span class="n">cst_name</span><span class="p">)</span>
                <span class="n">res</span><span class="p">[</span><span class="s">&quot;evaluation_model_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eval_data</span><span class="o">.</span><span class="n">get_model_count</span><span class="p">()</span>
                <span class="k">if</span> <span class="s">&quot;rmsd_native&quot;</span> <span class="ow">in</span> <span class="nb">next</span><span class="p">(</span><span class="n">eval_data</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()):</span>
                    <span class="n">res</span><span class="p">[</span><span class="s">&quot;evaluation_rmsd_native&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="s">&quot;rmsd_native&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">eval_data</span><span class="o">.</span><span class="n">get_models</span><span class="p">([</span><span class="s">&quot;1/1&quot;</span><span class="p">,</span> <span class="s">&quot;1/5&quot;</span><span class="p">,</span> <span class="s">&quot;1/10&quot;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s">&quot;cluster_ntop&quot;</span><span class="p">)]</span>
            <span class="k">except</span> <span class="n">SimulationException</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c"># motif model count</span>
        <span class="k">if</span> <span class="n">include_motif_model_count</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s">&quot;model_count_motifs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">get_model_count_in_silent_file</span><span class="p">,</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/motif</span><span class="si">%d</span><span class="s">*.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_motifs</span><span class="p">,</span> <span class="n">i</span><span class="p">))))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motifs&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span>

        <span class="c"># assembly model count</span>
        <span class="k">if</span> <span class="n">include_assembly_model_count</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s">&quot;model_count_assembly&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">get_model_count_in_silent_file</span><span class="p">,</span> <span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/assembly_*.out&quot;</span> <span class="o">%</span> <span class="n">dir_assembly</span><span class="p">))))</span>

        <span class="k">return</span> <span class="n">res</span>
</div>
<div class="viewcode-block" id="RNAPrediction.create_motifs"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.create_motifs">[docs]</a>    <span class="k">def</span> <span class="nf">create_motifs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nstruct</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">cycles</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_native_information</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">motif_subset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Motif generation step. Generate models for each motif.</span>

<span class="sd">        :param nstruct: number of models to create for each motif</span>
<span class="sd">        :param cycles: number of monte-carlo cycles per model</span>
<span class="sd">        :param dry_run: don&#39;t actually run any external command</span>
<span class="sd">        :param seed: optionally override random seed</span>
<span class="sd">        :param use_native_information: use native pdb file to calculate rmsd for each model</span>
<span class="sd">        :param threads: number of threads to use</span>
<span class="sd">        :param constraints: constraints selection</span>
<span class="sd">        :param motif_subset: sepcify a list of motifs to generate instead of all, counting starts at 1 (i.e. [1, 3, 4])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_config</span><span class="p">()</span>
        <span class="n">cst_name</span><span class="p">,</span> <span class="n">cst_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cst_name_and_filename</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;Motif creation configuration:&quot;</span>
        <span class="k">print</span> <span class="s">&quot;    constraints: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="k">print</span> <span class="s">&quot;    cycles: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cycles</span>
        <span class="k">print</span> <span class="s">&quot;    nstruct: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">nstruct</span>
        <span class="k">print</span> <span class="s">&quot;    dry_run: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dry_run</span>
        <span class="k">print</span> <span class="s">&quot;    random_seed: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">seed</span>
        <span class="k">print</span> <span class="s">&quot;    threads: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">threads</span>
        <span class="k">if</span> <span class="n">motif_subset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;    subset: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">motif_subset</span>

        <span class="n">dir_motifs</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/motifs&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cst_name</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">dir_motifs</span><span class="p">)</span>

        <span class="n">n_motifs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motifs&quot;</span><span class="p">])</span>

        <span class="c"># list of motifs that we should generate models for</span>
        <span class="c"># when no subset was given create models for all motifs</span>
        <span class="k">if</span> <span class="n">motif_subset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">motif_subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_motifs</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># remove duplicates if any</span>
            <span class="n">motif_subset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">motif_subset</span><span class="p">))</span>
            <span class="c"># make sure that all the numbers actually exist</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">motif_subset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_motifs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;Invalid motif subset. Structure only contains </span><span class="si">%d</span><span class="s"> motifs.&quot;</span> <span class="o">%</span> <span class="n">n_motifs</span><span class="p">)</span>

        <span class="c"># check if motif constraints were created correctly</span>
        <span class="k">if</span> <span class="n">cst_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">motif_subset</span><span class="p">:</span>
                <span class="n">check_file_existence</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/motif</span><span class="si">%d</span><span class="s">.cst&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_motifs</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="s">&quot;Motif cst files not found. Please run the &#39;prepare-cst&#39; step!&quot;</span><span class="p">)</span>

        <span class="c"># merge all motifs and check what we have so far</span>
        <span class="n">completed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">motif_subset</span><span class="p">:</span>
            <span class="n">completed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">merge_silent_files</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/motif</span><span class="si">%d</span><span class="s">.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_motifs</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/motif</span><span class="si">%d</span><span class="s">_*.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_motifs</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>

        <span class="n">commands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">motif_subset</span><span class="p">:</span>
            <span class="c"># split the rest of the work in multiple jobs</span>
            <span class="n">structs_missing</span> <span class="o">=</span> <span class="n">nstruct</span> <span class="o">-</span> <span class="n">completed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">print</span> <span class="s">&quot;motif </span><span class="si">%d</span><span class="s">:  completed: </span><span class="si">%d</span><span class="s">  missing: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">completed</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">structs_missing</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">structs_missing</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">structs_threads</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">threads</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">threads</span><span class="p">):</span>
                <span class="n">structs_threads</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">structs_missing</span> <span class="o">/</span> <span class="n">threads</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">structs_missing</span> <span class="o">%</span> <span class="n">threads</span><span class="p">):</span>
                <span class="n">structs_threads</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;rna_denovo&quot;</span><span class="p">,</span>
                       <span class="s">&quot;-fasta&quot;</span><span class="p">,</span> <span class="s">&quot;preparation/motif</span><span class="si">%d</span><span class="s">.fasta&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
                       <span class="s">&quot;-params_file&quot;</span><span class="p">,</span> <span class="s">&quot;preparation/motif</span><span class="si">%d</span><span class="s">.params&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
                       <span class="s">&quot;-cycles&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cycles</span><span class="p">,</span>
                       <span class="s">&quot;-mute&quot;</span><span class="p">,</span> <span class="s">&quot;all&quot;</span><span class="p">,</span>
                       <span class="s">&quot;-close_loops&quot;</span><span class="p">,</span>
                       <span class="s">&quot;-close_loops_after_each_move&quot;</span><span class="p">,</span>
                       <span class="s">&quot;-minimize_rna&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">cst_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;-cst_file&quot;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/motif</span><span class="si">%d</span><span class="s">.cst&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_motifs</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;native_pdb_file&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">use_native_information</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;-native&quot;</span><span class="p">,</span> <span class="s">&quot;preparation/motif</span><span class="si">%d</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;native_pdb_file&quot;</span><span class="p">])]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;data_file&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;-data_file&quot;</span><span class="p">,</span> <span class="s">&quot;preparation/motif</span><span class="si">%d</span><span class="s">.data&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;torsions_file&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;-vall_torsions&quot;</span><span class="p">,</span> <span class="s">&quot;preparation/motif</span><span class="si">%d</span><span class="s">.torsions&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span>

            <span class="n">which_stems</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">stem_chunk_res</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">motif_stem_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motif_stem_sets&quot;</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">motif_res_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motif_res_maps&quot;</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">motif_stem_set</span><span class="p">)):</span>
                <span class="n">motif_stem</span> <span class="o">=</span> <span class="n">motif_stem_set</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="c"># need to find in stems</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">])):</span>
                    <span class="n">stem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span>
                    <span class="n">found_match</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stem</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">motif_stem</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">stem</span><span class="p">[</span><span class="n">q</span><span class="p">]:</span>
                            <span class="n">found_match</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">found_match</span><span class="p">:</span>
                        <span class="n">which_stems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                        <span class="k">break</span>

                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stem</span><span class="p">)):</span>
                    <span class="n">stem_chunk_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">motif_res_map</span><span class="p">[</span><span class="n">stem</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stem</span><span class="p">)):</span>
                    <span class="n">stem_chunk_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">motif_res_map</span><span class="p">[</span><span class="n">stem</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">stem</span><span class="p">)</span> <span class="o">-</span> <span class="n">q</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;-in:file:silent_struct_type&quot;</span><span class="p">,</span> <span class="s">&quot;rna&quot;</span><span class="p">,</span>
                        <span class="s">&quot;-in:file:silent&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">which_stems</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;preparation/stem</span><span class="si">%d</span><span class="s">.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

            <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;-in:file:input_res&quot;</span><span class="p">]</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_tag_with_dashes</span><span class="p">(</span><span class="n">stem_chunk_res</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">threads</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">structs_threads</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">command_full</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="p">[</span><span class="s">&quot;-out:file:silent&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/motif</span><span class="si">%d</span><span class="s">_</span><span class="si">%d</span><span class="s">.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_motifs</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                          <span class="s">&quot;-nstruct&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">structs_threads</span><span class="p">[</span><span class="n">j</span><span class="p">])]</span>
                <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">command_full</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;-constant_seed&quot;</span><span class="p">,</span> <span class="s">&quot;-jran&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">seed</span><span class="p">]</span>
                    <span class="n">seed</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="n">command_full</span><span class="p">,</span> <span class="n">add_suffix</span><span class="o">=</span><span class="s">&quot;rosetta&quot;</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span>

        <span class="c"># merge motifs</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">motif_subset</span><span class="p">:</span>
            <span class="n">merge_silent_files</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/motif</span><span class="si">%d</span><span class="s">.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_motifs</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/motif</span><span class="si">%d</span><span class="s">_*.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_motifs</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="RNAPrediction.assemble"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.assemble">[docs]</a>    <span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nstruct</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">cycles</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_native_information</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assembly step. Assemble helices and motifs into complete models.</span>

<span class="sd">        :param nstruct: number of models to create</span>
<span class="sd">        :param cycles: number of monte-carlo cycles per model</span>
<span class="sd">        :param constraints: constraints selection</span>
<span class="sd">        :param dry_run: don&#39;t actually run any external command</span>
<span class="sd">        :param seed: optionally override random seed</span>
<span class="sd">        :param use_native_information: use native pdb file to calculate rmsd for each model</span>
<span class="sd">        :param threads: number of threads to use</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_config</span><span class="p">()</span>
        <span class="n">cst_name</span><span class="p">,</span> <span class="n">cst_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cst_name_and_filename</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;Assembly configuration:&quot;</span>
        <span class="k">print</span> <span class="s">&quot;    constraints: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="k">print</span> <span class="s">&quot;    cycles: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cycles</span>
        <span class="k">print</span> <span class="s">&quot;    nstruct: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">nstruct</span>
        <span class="k">print</span> <span class="s">&quot;    dry_run: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dry_run</span>
        <span class="k">print</span> <span class="s">&quot;    random_seed: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">seed</span>

        <span class="c"># Check if a different set of motifs should be used.</span>
        <span class="n">file_motif_override</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/MOTIF_OVERRIDE&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_motif_override</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_motif_override</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">motifcst_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">print</span> <span class="s">&quot;    using motifs: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">motifcst_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">motifcst_name</span> <span class="o">=</span> <span class="n">cst_name</span>

        <span class="n">dir_assembly</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/assembly&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">dir_motifs</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/motifs&quot;</span> <span class="o">%</span> <span class="n">motifcst_name</span>
        <span class="n">file_assembly_cst</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/assembly.cst&quot;</span> <span class="o">%</span> <span class="n">dir_assembly</span>

        <span class="n">check_file_existence</span><span class="p">(</span><span class="n">file_assembly_cst</span><span class="p">,</span> <span class="s">&quot;Preparation incomplete. Please run &#39;prepare-cst&#39;.&quot;</span><span class="p">)</span>
        <span class="n">check_file_existence</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/motif1.out&quot;</span> <span class="o">%</span> <span class="n">dir_motifs</span><span class="p">,</span> <span class="s">&quot;Motifs not found. Please run &#39;create-motifs&#39;.&quot;</span><span class="p">)</span>

        <span class="n">commands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;rna_denovo&quot;</span><span class="p">,</span>
                   <span class="s">&quot;-minimize_rna&quot;</span><span class="p">,</span>
                   <span class="s">&quot;-fasta&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;fasta_file&quot;</span><span class="p">],</span>
                   <span class="s">&quot;-in:file:silent_struct_type&quot;</span><span class="p">,</span> <span class="s">&quot;binary_rna&quot;</span><span class="p">,</span>
                   <span class="s">&quot;-cycles&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cycles</span><span class="p">,</span>
                   <span class="s">&quot;-params_file&quot;</span><span class="p">,</span> <span class="s">&quot;preparation/sequence.params&quot;</span><span class="p">,</span>
                   <span class="s">&quot;-close_loops&quot;</span><span class="p">,</span>
                   <span class="s">&quot;-in:file:silent&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">])):</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;preparation/stem</span><span class="si">%d</span><span class="s">.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motifs&quot;</span><span class="p">])):</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/motif</span><span class="si">%d</span><span class="s">.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_motifs</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">cst_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;-cst_file&quot;</span><span class="p">,</span> <span class="n">file_assembly_cst</span><span class="p">]</span>

        <span class="n">chunk_res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">])):</span>
            <span class="n">stem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;stems&quot;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stem</span><span class="p">)):</span>
                <span class="n">chunk_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stem</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stem</span><span class="p">)):</span>
                <span class="n">chunk_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stem</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">stem</span><span class="p">)</span> <span class="o">-</span> <span class="n">q</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motifs&quot;</span><span class="p">])):</span>
            <span class="n">motif_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;motifs&quot;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">motif_res</span><span class="p">:</span>
                <span class="n">chunk_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;-in:file:input_res&quot;</span><span class="p">]</span>
        <span class="n">command</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_tag_with_dashes</span><span class="p">(</span><span class="n">chunk_res</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;native_pdb_file&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">use_native_information</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;-native&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;native_pdb_file&quot;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;torsions_file&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;-vall_torsions&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;torsions_file&quot;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;data_file&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;-data_file&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;data_file&quot;</span><span class="p">]]</span>

        <span class="c"># distribute nstruct among threads</span>
        <span class="n">structs_threads</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">threads</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">threads</span><span class="p">):</span>
            <span class="n">structs_threads</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nstruct</span> <span class="o">/</span> <span class="n">threads</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nstruct</span> <span class="o">%</span> <span class="n">threads</span><span class="p">):</span>
            <span class="n">structs_threads</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">threads</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">structs_threads</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c"># In case no seed is specified, we do what rosetta does to get a random number, and seed it with that.</span>
            <span class="c"># This way we know the number beforehand and can choose an appropriate output filename.</span>
            <span class="c"># In case a seed was specified, we increment it here with the thread number.</span>
            <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">seed_used</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;=i&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seed_used</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">+</span> <span class="n">j</span>

            <span class="n">command_full</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="p">[</span><span class="s">&quot;-out:file:silent&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/assembly_</span><span class="si">%d</span><span class="s">.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_assembly</span><span class="p">,</span> <span class="n">seed_used</span><span class="p">),</span>
                                      <span class="s">&quot;-constant_seed&quot;</span><span class="p">,</span> <span class="s">&quot;-jran&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">seed_used</span><span class="p">,</span> <span class="s">&quot;--nstruct&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">structs_threads</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>

            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="n">command_full</span><span class="p">,</span> <span class="n">add_suffix</span><span class="o">=</span><span class="s">&quot;rosetta&quot;</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">execute_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span>

    <span class="c"># TODO: set the cutoff value back to 4.0? It was set to 4.1 because the old bash script used integer comparison and even 4.09 was treated as 4.0</span></div>
<div class="viewcode-block" id="RNAPrediction.evaluate"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cluster_limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cluster_cutoff</span><span class="o">=</span><span class="mf">4.1</span><span class="p">,</span> <span class="n">full_evaluation</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluation step. Extract model information, cluster models and calculate rmsd values.</span>

<span class="sd">        :param constraints: constraints selection</span>
<span class="sd">        :param cluster_limit: maximum number of clusters to produce</span>
<span class="sd">        :param cluster_cutoff: rmsd distance in A at which a new cluster is created</span>
<span class="sd">        :param full_evaluation: discard existing evaluation data, re-extract model information and re-calculate rmsd values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_config</span><span class="p">()</span>
        <span class="n">cst_name</span><span class="p">,</span> <span class="n">cst_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cst_name_and_filename</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;Evaluation configuration:&quot;</span>
        <span class="k">print</span> <span class="s">&quot;    constraints: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="k">print</span> <span class="s">&quot;    cluster_limit: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cluster_limit</span>
        <span class="k">print</span> <span class="s">&quot;    cluster_cutoff: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cluster_cutoff</span>

        <span class="n">dir_assembly</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/assembly&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">dir_output</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/output&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">dir_tmp</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/temp&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">file_evaldata</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/evaldata.dat&quot;</span> <span class="o">%</span> <span class="n">dir_output</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cst_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;No prediction directory for constraint &#39;</span><span class="si">%s</span><span class="s">&#39; found! Maybe you should assemble first?&quot;</span> <span class="o">%</span> <span class="n">cst_name</span><span class="p">)</span>

        <span class="n">files_assembly</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/assembly_*.out&quot;</span> <span class="o">%</span> <span class="n">dir_assembly</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">natural_sort_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files_assembly</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;No assembly files for constraint &#39;</span><span class="si">%s</span><span class="s">&#39; found! Maybe you should assemble first?&quot;</span> <span class="o">%</span> <span class="n">cst_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">full_evaluation</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_output</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_evaldata</span><span class="p">):</span>
                <span class="c"># first time, silently do a full eval</span>
                <span class="n">full_evaluation</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">eval_data</span> <span class="o">=</span> <span class="n">EvalData</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">file_evaldata</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">SimulationException</span><span class="p">:</span>
                    <span class="c"># file broken or missing, force full evaluation</span>
                    <span class="k">print</span> <span class="s">&quot;Warning: </span><span class="si">%s</span><span class="s"> missing or broken, running full evaluation.&quot;</span> <span class="o">%</span> <span class="n">file_evaldata</span>
                    <span class="n">full_evaluation</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">print</span> <span class="s">&quot;    full_evaluation: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">full_evaluation</span>

        <span class="c"># cleanup</span>
        <span class="k">if</span> <span class="n">full_evaluation</span><span class="p">:</span>
            <span class="n">delete_glob</span><span class="p">(</span><span class="n">dir_output</span><span class="p">)</span>
            <span class="n">delete_glob</span><span class="p">(</span><span class="n">dir_tmp</span><span class="p">)</span>
            <span class="c"># create empty evaluation data</span>
            <span class="n">eval_data</span> <span class="o">=</span> <span class="n">EvalData</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># clean out old cluster information from models</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">eval_data</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
                <span class="k">if</span> <span class="s">&quot;cluster&quot;</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">model</span><span class="p">[</span><span class="s">&quot;cluster&quot;</span><span class="p">]</span>

        <span class="n">eval_data</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">delete_glob</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s">&quot;*.pdb&quot;</span><span class="p">)</span>
        <span class="n">delete_glob</span><span class="p">(</span><span class="n">dir_output</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s">&quot;*.out&quot;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">dir_output</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">dir_tmp</span><span class="p">)</span>

        <span class="c"># extract info from .out files</span>
        <span class="k">if</span> <span class="n">full_evaluation</span><span class="p">:</span>
            <span class="c"># store all the rosetta scores in a dict</span>
            <span class="n">scores_headers</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c"># loop over all out files matching the constraint</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files_assembly</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;processing rosetta silent file: </span><span class="si">%s</span><span class="s">...&quot;</span> <span class="o">%</span> <span class="n">f</span>

                <span class="c"># read out file and store a dict of the scores and the full score line</span>
                <span class="n">regex_score</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^SCORE:\s+(.*)$&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_file_line_by_line</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">regex_score</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="c"># split rosetta score entries into a list</span>
                        <span class="n">scores</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="c"># store the header names if not already known</span>
                        <span class="k">if</span> <span class="n">scores</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;description&quot;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">scores_headers</span><span class="p">:</span>
                                <span class="n">scores_headers</span> <span class="o">=</span> <span class="n">scores</span>
                            <span class="k">continue</span>
                        <span class="c"># create a score dict</span>
                        <span class="n">scores_dict</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">s_index</span><span class="p">,</span> <span class="n">s_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scores_headers</span><span class="p">):</span>
                            <span class="c"># store float values as float</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">scores_dict</span><span class="p">[</span><span class="n">scores_headers</span><span class="p">[</span><span class="n">s_index</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">s_index</span><span class="p">])</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="n">scores_dict</span><span class="p">[</span><span class="n">scores_headers</span><span class="p">[</span><span class="n">s_index</span><span class="p">]]</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">s_index</span><span class="p">]</span>

                        <span class="c"># name models exactly like rosetta would (that is, append _&lt;num&gt; when already present)</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">tag</span> <span class="o">=</span> <span class="n">scores_dict</span><span class="p">[</span><span class="s">&quot;description&quot;</span><span class="p">]</span>
                        <span class="k">while</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">eval_data</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
                            <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores_dict</span><span class="p">[</span><span class="s">&quot;description&quot;</span><span class="p">],</span> <span class="n">j</span><span class="p">)</span>
                            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">eval_data</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;source_file&quot;</span><span class="p">:</span> <span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">),</span>
                                                 <span class="s">&quot;score&quot;</span><span class="p">:</span> <span class="n">scores_dict</span><span class="p">[</span><span class="s">&quot;score&quot;</span><span class="p">],</span>
                                                 <span class="s">&quot;tag&quot;</span><span class="p">:</span> <span class="n">tag</span><span class="p">,</span>
                                                 <span class="s">&quot;tag_source&quot;</span><span class="p">:</span> <span class="n">scores_dict</span><span class="p">[</span><span class="s">&quot;description&quot;</span><span class="p">],</span>
                                                 <span class="s">&quot;rosetta_scores&quot;</span><span class="p">:</span> <span class="n">scores_dict</span><span class="p">}</span>

        <span class="c"># clustering</span>
        <span class="n">eval_data</span><span class="o">.</span><span class="n">cluster_cutoff</span> <span class="o">=</span> <span class="n">cluster_cutoff</span>
        <span class="k">print</span> <span class="s">&quot;clustering models...&quot;</span>
        <span class="n">filename_clusters</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/clusters.out&quot;</span> <span class="o">%</span> <span class="n">dir_output</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="p">)</span>

        <span class="n">regex_clusters</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^.*RNA_PREDICT (old|new) cluster ([0-9]+) score ([-0-9.]+) model (S_[0-9_]+)$&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command_and_capture</span><span class="p">([</span><span class="s">&quot;rna_cluster&quot;</span><span class="p">,</span> <span class="s">&quot;-in:file:silent&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">files_assembly</span> <span class="o">+</span> <span class="p">[</span><span class="s">&quot;-cluster:radius&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cluster_cutoff</span><span class="p">,</span> <span class="s">&quot;-nstruct&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_limit</span><span class="p">),</span> <span class="s">&quot;-out:file:silent&quot;</span><span class="p">,</span> <span class="n">filename_clusters</span><span class="p">],</span> <span class="n">add_suffix</span><span class="o">=</span><span class="s">&quot;rosetta&quot;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">regex_clusters</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">eval_data</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)][</span><span class="s">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;new&quot;</span><span class="p">:</span>
                    <span class="n">eval_data</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;primary_model&quot;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)}</span>
                <span class="k">print</span> <span class="s">&quot;  </span><span class="si">%s</span><span class="s"> cluster: </span><span class="si">%02s</span><span class="s">, model: </span><span class="si">%-10s</span><span class="s">, score: </span><span class="si">%.3f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;new&quot;</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;new&quot;</span> <span class="k">else</span> <span class="s">&quot;   &quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>

        <span class="c"># extract cluster pdbs</span>
        <span class="k">print</span> <span class="s">&quot;extracting cluster decoy pdbs...&quot;</span>
        <span class="n">owd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_output</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">([</span><span class="s">&quot;rna_extract&quot;</span><span class="p">,</span> <span class="s">&quot;-in:file:silent&quot;</span><span class="p">,</span> <span class="n">basename</span><span class="p">(</span><span class="n">filename_clusters</span><span class="p">),</span> <span class="s">&quot;-in:file:silent_struct_type&quot;</span><span class="p">,</span> <span class="s">&quot;rna&quot;</span><span class="p">],</span> <span class="n">add_suffix</span><span class="o">=</span><span class="s">&quot;rosetta&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">owd</span><span class="p">)</span>

        <span class="c"># loop over all extracted pdb files</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fe</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/S_*.pdb&quot;</span> <span class="o">%</span> <span class="n">dir_output</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">natural_sort_key</span><span class="p">)):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/cluster_</span><span class="si">%d</span><span class="s">.pdb&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_output</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c"># rmsdcalc helper function</span>
        <span class="c"># noinspection PyShadowingNames</span>
        <span class="k">def</span> <span class="nf">calculate_rmsd</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">filename_comparison</span><span class="p">):</span>
            <span class="c"># calculate native rmsd values for all models if native pdb available</span>
            <span class="n">filename_tmp</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/rmsd.out&quot;</span> <span class="o">%</span> <span class="n">dir_tmp</span>
            <span class="k">print</span> <span class="s">&quot;caluculating rmsd values to </span><span class="si">%s</span><span class="s"> for all models...&quot;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="p">)</span>

            <span class="n">regex_rmsd</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^All atom rmsd over moving residues: (S_[0-9_]+) ([-0-9.]+)$&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command_and_capture</span><span class="p">([</span><span class="s">&quot;rna_score&quot;</span><span class="p">,</span> <span class="s">&quot;-in:file:silent&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">files_assembly</span> <span class="o">+</span> <span class="p">[</span><span class="s">&quot;-in:file:native&quot;</span><span class="p">,</span> <span class="n">filename_comparison</span><span class="p">,</span> <span class="s">&quot;-score:just_calc_rmsd&quot;</span><span class="p">,</span> <span class="s">&quot;-out:file:silent&quot;</span><span class="p">,</span> <span class="n">filename_tmp</span><span class="p">],</span> <span class="n">add_suffix</span><span class="o">=</span><span class="s">&quot;rosetta&quot;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">regex_rmsd</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">eval_data</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)][</span><span class="s">&quot;rmsd_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

            <span class="n">delete_glob</span><span class="p">(</span><span class="n">filename_tmp</span><span class="p">,</span> <span class="n">print_notice</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c"># only calculate rmsds if full_evalation is needed or wanted</span>
        <span class="k">if</span> <span class="n">full_evaluation</span><span class="p">:</span>
            <span class="c"># calculate rmsd to native structure if native pdb available</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;native_pdb_file&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">calculate_rmsd</span><span class="p">(</span><span class="s">&quot;native&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;native_pdb_file&quot;</span><span class="p">])</span>

            <span class="c"># calculate rmsd to best model</span>
            <span class="n">calculate_rmsd</span><span class="p">(</span><span class="s">&quot;cluster_1&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/cluster_1.pdb&quot;</span> <span class="o">%</span> <span class="n">dir_output</span><span class="p">)</span>

        <span class="c"># save evaluation data</span>
        <span class="n">eval_data</span><span class="o">.</span><span class="n">save_to_file</span><span class="p">(</span><span class="n">file_evaldata</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RNAPrediction.evaluate_custom"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.evaluate_custom">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_custom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dca_prediction_filename</span><span class="o">=</span><span class="s">&quot;dca/dca.txt&quot;</span><span class="p">,</span> <span class="n">full_evaluation</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">number_dca_predictions</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Custom scoring algorithmy by inspecting neighboring residues of dca contact pairs</span>

<span class="sd">        :param constraints: constraints selection</span>
<span class="sd">        :param dca_prediction_filename: dca filename</span>
<span class="sd">        :param full_evaluation: discard existing evaluation data and extracted models, re-extract and re-calculate distance information</span>
<span class="sd">        :param threshold: threshold in A to count a contact</span>
<span class="sd">        :param radius: number of adjacent residues to inspect</span>
<span class="sd">        :param number_dca_predictions: maximum number of DCA predictions to use</span>
<span class="sd">        :param threads: number of threads to use for extraction</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_config</span><span class="p">()</span>
        <span class="n">cst_name</span><span class="p">,</span> <span class="n">cst_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cst_name_and_filename</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;Evaluation configuration:&quot;</span>
        <span class="k">print</span> <span class="s">&quot;    constraints: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="k">print</span> <span class="s">&quot;    dca_file: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dca_prediction_filename</span>
        <span class="k">print</span> <span class="s">&quot;    dca_count: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">number_dca_predictions</span>
        <span class="k">print</span> <span class="s">&quot;    threshold: </span><span class="si">%f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">threshold</span>
        <span class="k">print</span> <span class="s">&quot;    radius: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">radius</span>

        <span class="n">dir_assembly</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/assembly&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">dir_output</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/output&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">dir_tmp</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/temp&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">file_evaldata</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/evaldata.dat&quot;</span> <span class="o">%</span> <span class="n">dir_output</span>
        <span class="n">file_matrices</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/matrices.dat&quot;</span> <span class="o">%</span> <span class="n">dir_tmp</span>

        <span class="n">files_assembly</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/assembly_*.out&quot;</span> <span class="o">%</span> <span class="n">dir_assembly</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">natural_sort_key</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">eval_data</span> <span class="o">=</span> <span class="n">EvalData</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">file_evaldata</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">SimulationException</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;Normal --evaluate step needs to be run before --evaluate-custom.&quot;</span><span class="p">)</span>

        <span class="n">slen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">])</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">dir_output</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">dir_tmp</span><span class="p">)</span>

        <span class="n">extract</span> <span class="o">=</span> <span class="n">full_evaluation</span>
        <span class="n">build_matrices</span> <span class="o">=</span> <span class="n">full_evaluation</span>

        <span class="c"># check if we can use existing data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">build_matrices</span><span class="p">:</span>
            <span class="c"># try to load existing distance matrix</span>
            <span class="k">print</span> <span class="s">&quot;loading existing distance matrices...&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_matrices</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">distance_matrices</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PickleError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;error loading existing matrices. forcing rebuild...&quot;</span>
                <span class="n">build_matrices</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="c"># check if we need to extract pdb files</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">.pdb&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_tmp</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">eval_data</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()))):</span>
                    <span class="k">print</span> <span class="s">&quot;no extraced pdb files found. forcing extraction...&quot;</span>
                    <span class="n">extract</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># extract all pdb files to temp dir</span>
        <span class="k">if</span> <span class="n">extract</span><span class="p">:</span>
            <span class="n">delete_glob</span><span class="p">(</span><span class="n">dir_tmp</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;extracing pdb files...&quot;</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_assembly</span><span class="p">:</span>
                <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Command</span><span class="p">([</span><span class="s">&quot;rna_extract&quot;</span><span class="p">,</span> <span class="s">&quot;-in:file:silent&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="s">&quot;-in:file:silent_struct_type&quot;</span><span class="p">,</span> <span class="s">&quot;rna&quot;</span><span class="p">,</span> <span class="s">&quot;-out:prefix&quot;</span><span class="p">,</span> <span class="n">dir_tmp</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span><span class="p">],</span> <span class="n">add_suffix</span><span class="o">=</span><span class="s">&quot;rosetta&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">eval_data</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">dir_tmp</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s">&quot;source_file&quot;</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="s">&quot;tag_source&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;.pdb&quot;</span><span class="p">,</span> <span class="n">dir_tmp</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="s">&quot;tag&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;.pdb&quot;</span><span class="p">)</span>

        <span class="c"># build residue distance matrix for all models</span>
        <span class="k">if</span> <span class="n">build_matrices</span><span class="p">:</span>
            <span class="n">delete_glob</span><span class="p">(</span><span class="n">file_matrices</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;building matrices for </span><span class="si">%d</span><span class="s"> models...&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">eval_data</span><span class="o">.</span><span class="n">models</span><span class="p">)</span>
            <span class="n">distance_matrices</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">eval_data</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">])])</span>
                <span class="n">chain</span> <span class="o">=</span> <span class="n">pdbtools</span><span class="o">.</span><span class="n">parse_pdb</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">dir_tmp</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="s">&quot;tag&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;.pdb&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">child_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">slen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">slen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">matrix</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&quot;P&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">chain</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s">&quot;P&quot;</span><span class="p">]</span>
                <span class="n">distance_matrices</span><span class="p">[</span><span class="n">model</span><span class="p">[</span><span class="s">&quot;tag&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matrix</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">...&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;</span><span class="si">%x</span><span class="s">...&quot;</span> <span class="o">%</span> <span class="n">x</span>
            <span class="k">print</span> <span class="s">&quot;done.&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_matrices</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">distance_matrices</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="c"># calculate scores</span>
        <span class="k">print</span> <span class="s">&quot;calculating scores...&quot;</span>
        <span class="n">dca</span> <span class="o">=</span> <span class="n">dcatools</span><span class="o">.</span><span class="n">parse_dca_data</span><span class="p">(</span><span class="n">dca_prediction_filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">eval_data</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">score_custom</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">distance_matrices</span><span class="p">[</span><span class="n">model</span><span class="p">[</span><span class="s">&quot;tag&quot;</span><span class="p">]]</span>
            <span class="n">c_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">dca</span><span class="p">:</span>
                <span class="n">c_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">c_count</span> <span class="o">&gt;</span> <span class="n">number_dca_predictions</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">contact</span><span class="o">.</span><span class="n">res1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">contact</span><span class="o">.</span><span class="n">res1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">slen</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">contact</span><span class="o">.</span><span class="n">res2</span> <span class="o">+</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">contact</span><span class="o">.</span><span class="n">res2</span> <span class="o">+</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">slen</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">contact</span><span class="o">.</span><span class="n">res1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="n">contact</span><span class="o">.</span><span class="n">res2</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">matrix</span><span class="p">[</span><span class="n">contact</span><span class="o">.</span><span class="n">res1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">contact</span><span class="o">.</span><span class="n">res2</span> <span class="o">+</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="n">score_custom</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">print</span> <span class="s">&quot;model: </span><span class="si">%-11s</span><span class="s">, score: </span><span class="si">%8.3f</span><span class="s">, score_custom: </span><span class="si">%3d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s">&quot;tag&quot;</span><span class="p">],</span> <span class="n">model</span><span class="p">[</span><span class="s">&quot;score&quot;</span><span class="p">],</span> <span class="n">score_custom</span><span class="p">)</span>
            <span class="n">model</span><span class="p">[</span><span class="s">&quot;score_custom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_custom</span>

        <span class="n">eval_data</span><span class="o">.</span><span class="n">save_to_file</span><span class="p">(</span><span class="n">file_evaldata</span><span class="p">)</span>

    <span class="c"># returns the path to the extracted pdb file</span></div>
<div class="viewcode-block" id="RNAPrediction.extract_pdb"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.extract_pdb">[docs]</a>    <span class="k">def</span> <span class="nf">extract_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract PDB file of a model to the tmp directory.</span>

<span class="sd">        :param constraints: constraints selection</span>
<span class="sd">        :param model: tag of the model</span>
<span class="sd">        :return: path to the extracted PDB file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cst_name</span><span class="p">,</span> <span class="n">cst_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cst_name_and_filename</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">dir_assembly</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/assembly&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">dir_tmp</span> <span class="o">=</span> <span class="s">&quot;predictions/</span><span class="si">%s</span><span class="s">/temp&quot;</span> <span class="o">%</span> <span class="n">cst_name</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">dir_tmp</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s">&quot;tmp_&quot;</span>
        <span class="n">pdbfile</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">.pdb&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_tmp</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s">&quot;tag&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">([</span><span class="s">&quot;rna_extract&quot;</span><span class="p">,</span> <span class="s">&quot;-in:file:silent&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_assembly</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s">&quot;source_file&quot;</span><span class="p">]),</span> <span class="s">&quot;-out:prefix&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="s">&quot;-tags&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s">&quot;tag_source&quot;</span><span class="p">]],</span> <span class="n">add_suffix</span><span class="o">=</span><span class="s">&quot;rosetta&quot;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/tmp_</span><span class="si">%s</span><span class="s">.pdb&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dir_tmp</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s">&quot;tag_source&quot;</span><span class="p">]),</span> <span class="n">pdbfile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pdbfile</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="RNAPrediction.get_models"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.get_models">[docs]</a>    <span class="k">def</span> <span class="nf">get_models</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">model_list</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&quot;tag&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a selection of models with specific properties</span>

<span class="sd">        :param constraints: constraints selection</span>
<span class="sd">        :param model_list: see EvalData.print_models</span>
<span class="sd">        :param kind: see EvalData.get_models</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">EvalData</span><span class="o">.</span><span class="n">load_from_cst</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span><span class="o">.</span><span class="n">get_models</span><span class="p">(</span><span class="n">model_list</span><span class="o">=</span><span class="n">model_list</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="RNAPrediction.print_models"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.print_models">[docs]</a>    <span class="k">def</span> <span class="nf">print_models</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">model_list</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&quot;tag&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print a set of models</span>

<span class="sd">        :param constraints: constraints selection</span>
<span class="sd">        :param model_list: see EvalData.print_models</span>
<span class="sd">        :param kind: see EvalData.print_models</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">EvalData</span><span class="o">.</span><span class="n">load_from_cst</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span><span class="o">.</span><span class="n">print_models</span><span class="p">(</span><span class="n">model_list</span><span class="o">=</span><span class="n">model_list</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RNAPrediction.extract_models"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.extract_models">[docs]</a>    <span class="k">def</span> <span class="nf">extract_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">model_list</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&quot;tag&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract PDB files of a set of models</span>

<span class="sd">        :param constraints: constraints selection</span>
<span class="sd">        :param model_list: see EvalData.print_models</span>
<span class="sd">        :param kind: see EvalData.print_models</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">EvalData</span><span class="o">.</span><span class="n">load_from_cst</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span><span class="o">.</span><span class="n">get_models</span><span class="p">(</span><span class="n">model_list</span><span class="o">=</span><span class="n">model_list</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">):</span>
            <span class="n">pdbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_pdb</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;Extracted: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pdbfile</span>

    <span class="c"># TODO: include mapping_mode?</span></div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_constraints_output_filename</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="n">cst_function</span><span class="p">,</span> <span class="n">number_dca_predictions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s">&quot;%n_</span><span class="si">%f</span><span class="s">&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a reasonable constraints output filename based on input filename and a formatting string.</span>

<span class="sd">        The formatting string can include placeholdes</span>

<span class="sd">        :param input_filename: input cst filename</span>
<span class="sd">        :param output_filename: fixed output filename or basename or None to automatically format using output_format</span>
<span class="sd">        :param cst_function: rosetta function</span>
<span class="sd">        :param number_dca_predictions: maximum number of DCA predictions to use</span>
<span class="sd">        :param output_format: formatting string containing placeholders: %f: rosetta function</span>
<span class="sd">                                                                         %n: basename of source file</span>
<span class="sd">                                                                         %d: number of dca predictions</span>
<span class="sd">        :return: output filename</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_basename</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">input_filename</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cst_function_underscore</span> <span class="o">=</span> <span class="n">cst_function</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span>

        <span class="c"># chose a default filename, is none given</span>
        <span class="k">if</span> <span class="n">output_filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">output_filename</span> <span class="o">=</span> <span class="s">&quot;constraints/</span><span class="si">%s</span><span class="s">.cst&quot;</span> <span class="o">%</span> <span class="n">output_format</span>
        <span class="c"># check if a path was given, if not put it in the constraints dir</span>
        <span class="k">elif</span> <span class="n">basename</span><span class="p">(</span><span class="n">output_filename</span><span class="p">)</span> <span class="o">==</span> <span class="n">output_filename</span><span class="p">:</span>
            <span class="n">output_filename</span> <span class="o">=</span> <span class="s">&quot;constraints/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">output_filename</span>

        <span class="c"># make sure the filename always ends in .cst</span>
        <span class="k">if</span> <span class="n">splitext</span><span class="p">(</span><span class="n">output_filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;.cst&quot;</span><span class="p">:</span>
            <span class="n">output_filename</span> <span class="o">+=</span> <span class="s">&quot;.cst&quot;</span>

        <span class="c"># replace placeholders with actual values</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">output_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%f</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cst_function_underscore</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;%n&quot;</span><span class="p">,</span> <span class="n">source_basename</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">number_dca_predictions</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">output_filename</span>

<div class="viewcode-block" id="RNAPrediction.parse_dca_filter_string"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.parse_dca_filter_string">[docs]</a>    <span class="k">def</span> <span class="nf">parse_dca_filter_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a text string and turn it tinto a list of DCA filters</span>

<span class="sd">        Multiple filters are separated by command and have the folling format:</span>

<span class="sd">        ``&lt;filter&gt;:&lt;arg&gt;:&lt;arg&gt;:...``</span>


<span class="sd">        Threshold filter: Lookup dca contacts in a PDB file, discard or keep contact depending on whether the contact is realized:</span>

<span class="sd">        Format: ``threshold:&lt;n&gt;:&lt;cst&gt;:&lt;mode&gt;:&lt;moodel&gt;``</span>

<span class="sd">        - n: threshold (&lt; 0: keep below, &gt; 0: keep above)</span>
<span class="sd">        - cst: constraints selection to look up PDB file</span>
<span class="sd">        - mode, model: model selection mode (see EvalData.get_models for details)</span>

<span class="sd">        Example: ``threshold:8.0:100rnaDCA_FADE_-100_26_20_-2_2:cluster:1,threshold:-6.0:100rnaDCA_FADE_-100_26_20_-2_2:cluster:1``</span>


<span class="sd">        None filter: Empty filter</span>

<span class="sd">        Format: ``none``</span>

<span class="sd">        :param line: string to parse</span>
<span class="sd">        :return: list of DcaFilter objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filter_chain</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># filters are split by &quot;,&quot;</span>
        <span class="k">for</span> <span class="n">filtertext</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">):</span>
            <span class="c"># initialize to None to suppress warning</span>
            <span class="n">dca_filter</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># filter fields are split by &quot;:&quot;</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">filtertext</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;none&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;threshold&quot;</span><span class="p">:</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">cst_name</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">model_kind</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">model_i</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">eval_data</span> <span class="o">=</span> <span class="n">EvalData</span><span class="o">.</span><span class="n">load_from_cst</span><span class="p">(</span><span class="n">cst_name</span><span class="p">)</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">eval_data</span><span class="o">.</span><span class="n">get_models</span><span class="p">([</span><span class="n">model_i</span><span class="p">],</span> <span class="n">model_kind</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pdbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_pdb</span><span class="p">(</span><span class="n">cst_name</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
                <span class="n">filter_pdb_chain</span> <span class="o">=</span> <span class="n">pdbtools</span><span class="o">.</span><span class="n">parse_pdb</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">pdbfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">child_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dca_filter</span> <span class="o">=</span> <span class="n">dcatools</span><span class="o">.</span><span class="n">DcaFilterThreshold</span><span class="p">(</span><span class="n">filter_pdb_chain</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">threshold</span><span class="p">),</span> <span class="n">keep_below</span><span class="o">=</span><span class="n">threshold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;minimum_heavy&quot;</span><span class="p">)</span>
            <span class="n">filter_chain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dca_filter</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filter_chain</span>
</div>
<div class="viewcode-block" id="RNAPrediction.make_constraints"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.make_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">make_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dca_prediction_filename</span><span class="o">=</span><span class="s">&quot;dca/dca.txt&quot;</span><span class="p">,</span> <span class="n">output_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">number_dca_predictions</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">cst_function</span><span class="o">=</span><span class="s">&quot;FADE -100 26 20 -2 2&quot;</span><span class="p">,</span> <span class="n">filter_text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mapping_mode</span><span class="o">=</span><span class="s">&quot;minAtom&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a set of constraints from a DCA prediction.</span>

<span class="sd">        :param dca_prediction_filename: DCA input file</span>
<span class="sd">        :param output_filename: fixed output filename or None to automatically create</span>
<span class="sd">        :param number_dca_predictions: maximum number of DCA predictions to use</span>
<span class="sd">        :param cst_function: rosetta function and parameters as text string</span>
<span class="sd">        :param filter_text: optional: List of DCA filters (see parse_dca_filter_string for details)</span>
<span class="sd">        :param mapping_mode: atom-to-atom mapping mode to use, supported values: ``minAtom`` or ``pOnly``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_config</span><span class="p">()</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_constraints_output_filename</span><span class="p">(</span><span class="n">dca_prediction_filename</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="n">cst_function</span><span class="p">,</span> <span class="n">number_dca_predictions</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">%n_</span><span class="si">%f</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;Constraints creation:&quot;</span>
        <span class="k">print</span> <span class="s">&quot;    dca_prediction_filename: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dca_prediction_filename</span>
        <span class="k">print</span> <span class="s">&quot;    output_filename: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">output_filename</span>
        <span class="k">print</span> <span class="s">&quot;    number_dca_predictions: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">number_dca_predictions</span>
        <span class="k">print</span> <span class="s">&quot;    mode: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mapping_mode</span>
        <span class="k">print</span> <span class="s">&quot;    function: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cst_function</span>
        <span class="k">print</span> <span class="s">&quot;    filter: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filter_text</span>
        <span class="n">check_file_existence</span><span class="p">(</span><span class="n">dca_prediction_filename</span><span class="p">)</span>

        <span class="c"># load dca contacts from file</span>
        <span class="n">dca</span> <span class="o">=</span> <span class="n">dcatools</span><span class="o">.</span><span class="n">parse_dca_data</span><span class="p">(</span><span class="n">dca_prediction_filename</span><span class="p">)</span>

        <span class="c"># filter dca data</span>
        <span class="k">if</span> <span class="n">filter_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Filtering dca data:&quot;</span>
            <span class="n">dca_filter_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_dca_filter_string</span><span class="p">(</span><span class="n">filter_text</span><span class="p">)</span>
            <span class="n">dcatools</span><span class="o">.</span><span class="n">filter_dca_data</span><span class="p">(</span><span class="n">dca_data</span><span class="o">=</span><span class="n">dca</span><span class="p">,</span> <span class="n">dca_filter_chain</span><span class="o">=</span><span class="n">dca_filter_chain</span><span class="p">)</span>

        <span class="c"># create constraints</span>
        <span class="k">print</span> <span class="s">&quot;Creating constraints:&quot;</span>

        <span class="n">cst_info</span> <span class="o">=</span> <span class="n">dcatools</span><span class="o">.</span><span class="n">build_cst_info_from_dca_contacts</span><span class="p">(</span><span class="n">dca</span><span class="p">,</span> <span class="n">sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;sequence&quot;</span><span class="p">],</span> <span class="n">mapping_mode</span><span class="o">=</span><span class="n">mapping_mode</span><span class="p">,</span> <span class="n">cst_function</span><span class="o">=</span><span class="n">cst_function</span><span class="p">,</span> <span class="n">number_dca_predictions</span><span class="o">=</span><span class="n">number_dca_predictions</span><span class="p">)</span>

        <span class="c"># write to file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cst_info</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">]))))</span>
</div>
<div class="viewcode-block" id="RNAPrediction.edit_constraints"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.edit_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">edit_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">output_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cst_function</span><span class="o">=</span><span class="s">&quot;FADE -100 26 20 -2 2&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Edit an existing .cst file, replacing the rosetta function.</span>

<span class="sd">        :param constraints: constraints selection</span>
<span class="sd">        :param output_filename: fixed output filename or None to automatically create</span>
<span class="sd">        :param cst_function: rosetta function and parameters as text string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cst_name</span><span class="p">,</span> <span class="n">input_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cst_name_and_filename</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_constraints_output_filename</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="n">cst_function</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;Constraints editing:&quot;</span>
        <span class="k">print</span> <span class="s">&quot;    input_filename:  </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">input_filename</span>
        <span class="k">print</span> <span class="s">&quot;    output_filename: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">output_filename</span>
        <span class="k">print</span> <span class="s">&quot;    function:       </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cst_function</span>
        <span class="n">check_file_existence</span><span class="p">(</span><span class="n">input_filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_filename</span> <span class="o">==</span> <span class="n">output_filename</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;Input and output filename cannot be the same&quot;</span><span class="p">)</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;^(\S+\s+\d+\s+\S+\s+\d+)\s+(\S+)\s+.+$&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_fd</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_file_line_by_line</span><span class="p">(</span><span class="n">input_filename</span><span class="p">):</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">output_fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">cst_function</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="RNAPrediction.print_status"><a class="viewcode-back" href="../../rna_predict.html#rna_predict.simulation.RNAPrediction.print_status">[docs]</a>    <span class="k">def</span> <span class="nf">print_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">native_compare</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">csts</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print summary of predictions and their current status.</span>

<span class="sd">        Output format always contains the following columns:</span>

<span class="sd">        - P: preparation step</span>
<span class="sd">        - M: motif generation</span>
<span class="sd">        - A: assembly</span>
<span class="sd">        - E: evaluation</span>

<span class="sd">        If a step is completed, ``X`` is shown, ``-`` otherwise.</span>

<span class="sd">        For motif generation a ``*`` may be shown to indicate that models from a different</span>
<span class="sd">        set of constraints are used.</span>

<span class="sd">        If *native_compare* is set to True another 4 columns are printed:</span>

<span class="sd">        - 1: native rmsd score of the first cluster</span>
<span class="sd">        - 5: lowest native rmsd score of the first 5 clusters</span>
<span class="sd">        - 10: lowest native rmsd score of the first 10 clusters</span>
<span class="sd">        - n: number of models</span>

<span class="sd">        :param native_compare: print rmsd comparison to native structure</span>
<span class="sd">        :param csts: list of constraints to include in output (default: all)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_config</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">native_compare</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;native_pdb_file&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationException</span><span class="p">(</span><span class="s">&quot;Cannot compare without native information.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">csts</span><span class="p">:</span>
            <span class="c"># cst selection</span>
            <span class="n">cst_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_cst_name_and_filename</span><span class="p">(</span><span class="n">cst</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">cst</span> <span class="ow">in</span> <span class="n">csts</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cst_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_csts</span><span class="p">()</span>

        <span class="k">print</span> <span class="s">&quot;Status: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">print</span> <span class="s">&quot;  cst                                 P M A E&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;       1     5    10     n&quot;</span> <span class="k">if</span> <span class="n">native_compare</span> <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;  -------------------------------------------&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;--------------------------&quot;</span> <span class="k">if</span> <span class="n">native_compare</span> <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cst_name</span> <span class="ow">in</span> <span class="n">cst_names</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">cst_name</span><span class="p">,</span> <span class="n">include_evaluation_data</span><span class="o">=</span><span class="n">native_compare</span><span class="p">)</span>

            <span class="n">done_preparation</span> <span class="o">=</span> <span class="s">&quot;X&quot;</span> <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s">&quot;step_preparation_done&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s">&quot;-&quot;</span>
            <span class="n">done_motifs</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span> <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s">&quot;step_motifs_overridden&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="s">&quot;X&quot;</span> <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s">&quot;step_motifs_done&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">done_assembly</span> <span class="o">=</span> <span class="s">&quot;X&quot;</span> <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s">&quot;step_assembly_done&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s">&quot;-&quot;</span>
            <span class="n">done_evaluation</span> <span class="o">=</span> <span class="s">&quot;X&quot;</span> <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s">&quot;step_evaluation_done&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s">&quot;-&quot;</span>

            <span class="n">line</span> <span class="o">=</span> <span class="s">&quot;  </span><span class="si">%-035s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cst_name</span><span class="p">,</span> <span class="n">done_preparation</span><span class="p">,</span> <span class="n">done_motifs</span><span class="p">,</span> <span class="n">done_assembly</span><span class="p">,</span> <span class="n">done_evaluation</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">native_compare</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&quot;evaluation_rmsd_native&quot;</span> <span class="ow">in</span> <span class="n">status</span> <span class="ow">and</span> <span class="n">status</span><span class="p">[</span><span class="s">&quot;evaluation_rmsd_native&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">rmsds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">status</span><span class="p">[</span><span class="s">&quot;evaluation_rmsd_native&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rmsds</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot;   </span><span class="si">%05s</span><span class="s"> </span><span class="si">%05s</span><span class="s"> </span><span class="si">%05s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">rmsds</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot; </span><span class="si">%05s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s">&quot;evaluation_model_count&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s">&quot;evaluation_model_count&quot;</span> <span class="ow">in</span> <span class="n">status</span> <span class="ow">and</span> <span class="n">status</span><span class="p">[</span><span class="s">&quot;evaluation_model_count&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&quot;-&quot;</span><span class="p">)</span>

            <span class="k">print</span> <span class="n">line</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">rna_predict 0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Sebastian Ratz.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>